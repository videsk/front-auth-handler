!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.WebAuth=t():e.WebAuth=t()}(window,function(){return function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";var o,r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=n(1),c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var n=t.keys,o=void 0===n?{accessToken:"auth-key",refreshToken:"auth-key-refresh"}:n,r=t.config,s=void 0===r?{endpoints:{hostname:"http://localhost:3000/",accessToken:{url:"check-token",method:"GET",authorizationType:"Bearer",headers:{"Content-Type":"application/json"},body:{},keys:{accessToken:"accessToken",refreshToken:"refreshToken"},status:{expired:401,ok:200},attempts:3},refreshToken:{url:"refresh-token",method:"POST",authorizationType:"Bearer",headers:{"Content-Type":"application/json"},body:{},keys:{accessToken:"accessToken",refreshToken:"refreshToken"},status:{expired:401,ok:201},attempts:3}}}:r;this.keys=o,this.events={expired:function(){},error:function(){},renewed:function(){},empty:function(){}},this.config=s,this.storage=window.localStorage.getItem(this.keys.accessToken)?"localStorage":"sessionStorage",this._expirationAccessToken=null,this._expirationRefreshToken=null,this._stop=!1}return s(e,[{key:"set",value:async function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments[2];"boolean"==typeof n&&(this.storage=n?"localStorage":"sessionStorage");var o=this.constructor.getStorage(this.storage,this.keys),r=o.accessToken,s=void 0===r?e:r,i=o.refreshToken,a=void 0===i?t:i;if(!s)return this.events.empty();try{this._expirationAccessToken=this.constructor.getExpirationToken(s),a&&(this._expirationRefreshToken=this.constructor.getExpirationToken(a))}catch(e){return this.events.error(e)}this.constructor.saveTokens(this.storage,this.keys,s,a);try{return await this.askServer(),this.observer()}catch(e){return"undefined"!==e?this.events.error(e):(this.events.expired("accessToken"),this.renew())}}},{key:"on",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};this.events[e]=t}},{key:"clean",value:function(){window.localStorage.removeItem(this.keys.accessToken),window.localStorage.removeItem(this.keys.refreshToken),window.sessionStorage.removeItem(this.keys.accessToken),window.sessionStorage.removeItem(this.keys.refreshToken)}},{key:"observer",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(!this._stop&&this._expirationAccessToken){var n=(new Date).getTime()>this._expirationAccessToken;if(!n)return setTimeout(function(){return e.observer()},1e3);if(t<2&&this.events.expired("accessToken"),this._expirationRefreshToken)return this.renew(t)}}},{key:"renew",value:async function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=(new Date).getTime()>this._expirationRefreshToken;if(n)return this.events.expired("refreshToken");var o=this.config.endpoints.refreshToken,r=this.constructor.getTokens(this.storage,this.keys),s=r.refreshToken;try{var i=o.keys.accessToken,a=await this.askServer("refreshToken");return this.constructor.saveTokens(this.storage,this.keys,a[i],s),this._expirationAccessToken=this.constructor.getExpirationToken(a[i]),this._expirationRefreshToken=this.constructor.getExpirationToken(s),this.events.renewed(),this.observer()}catch(n){if(!n)return;if(t>=o.attempts)return this.events.error(n);setTimeout(function(){return e.observer(t+1)},1e3*(t+1))}}},{key:"askServer",value:async function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"accessToken";if(!this._stop){var t=this.config.endpoints[e],n=t.url,o=t.body,r=t.headers,s=t.method,a=t.authorizationType,c=t.keys,u=t.status,h=this.constructor.getTokens(this.storage,this.keys),f=Object.assign(r,{Authorization:a+" "+h[e]}),l=Object.assign(o,i({},c[e],h[e])),d=""+this.config.endpoints.hostname+n,p={method:s,headers:f};["post","patch","put"].includes(s.toLowerCase())&&(p.body=JSON.stringify(l));var v=await fetch(d,p);if(v.status===u.ok)return v.json();if(v.status!==u.expired&&v instanceof Error)throw v;throw this.clean(),this.events.expired(e)}}},{key:"stop",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._stop=e,this.clean()}}],[{key:"getTokens",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"sessionStorage",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=window[e].getItem(t.accessToken),o=window[e].getItem(t.refreshToken);return n||o?{accessToken:n,refreshToken:o}:{}}},{key:"saveTokens",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"sessionStorage",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";window[e].setItem(t.accessToken,n),window[e].setItem(t.refreshToken,o)}},{key:"getExpirationToken",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=a(e);if("object"!==(void 0===t?"undefined":r(t)))throw new Error("Invalid JWT, please check.");return"exp"in t?1e3*t.exp:1/0}},{key:"getStorage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return window.localStorage.getItem(e)?"localStorage":"sessionStorage"}}]),e}();e.exports=c,void 0===(o=function(){return c}.apply(t,[]))||(e.exports=o)},function(e,t,n){"use strict";function o(e){this.message=e}Object.defineProperty(t,"__esModule",{value:!0}),o.prototype=new Error,o.prototype.name="InvalidCharacterError";var r="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new o("'atob' failed: The string to be decoded is not correctly encoded.");for(var n,r,s=0,i=0,a="";r=t.charAt(i++);~r&&(n=s%4?64*n+r:r,s++%4)?a+=String.fromCharCode(255&n>>(-2*s&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return a};function s(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return decodeURIComponent(r(t).replace(/(.)/g,function(e,t){var n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}catch(e){return r(t)}}function i(e){this.message=e}i.prototype=new Error,i.prototype.name="InvalidTokenError",t.default=function(e,t){if("string"!=typeof e)throw new i("Invalid token specified");var n=!0===(t=t||{}).header?0:1;try{return JSON.parse(s(e.split(".")[n]))}catch(e){throw new i("Invalid token specified: "+e.message)}},t.InvalidTokenError=i}])});
//# sourceMappingURL=web-auth.min.js.map