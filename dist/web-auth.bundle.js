!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.WebAuth=t():e.WebAuth=t()}(window,function(){return function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";var o,r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),a=n(1),s=(o=a)&&o.__esModule?o:{default:o};e.exports=function(){function e(t){var n=t.keys,o=t.tokens,i=t.remember,a=t.config,s=t.expired;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.tokens={access:o&&"access"in o?o.access:null,refresh:o&&"refresh"in o?o.refresh:null},this.payloads={access:null,refresh:null},this.keys={access:n&&"access"in n?n.access:"auth-key",refresh:n&&"refresh"in n?n.refresh:"auth-key-refresh"},this.debug="debug"in a&&"boolean"==typeof a.debug&&a.debug,this.remember="boolean"==typeof i?i:void 0,this.config="object"===(void 0===a?"undefined":r(a))?a:null,this.expired="function"==typeof s?s:function(){},this.interval={execute:null,try:0}}return i(e,[{key:"init",value:function(){var e=this;return new Promise(function(t,n){try{e.Debug("info","Initializing WebAuth... (36)"),e.tokens.access=e.tokens.access||e.getFromStorage(e.keys.access),e.tokens.refresh=e.tokens.refresh||e.getFromStorage(e.keys.refresh),e.remember="boolean"==typeof e.remember?e.remember:e.checkStorage(e.keys.access).remember,e.Debug("info","Configuration in process... (43)"),e.setup().then(function(){e.Debug("info","Checking expiration... (47)"),e.checkExpiration("access").then(function(o){e.Debug("info","Creating pathname object... (50)");var r={pathname:Object.assign(e.getSearchOrHash(),e.nestedPathname())};e.Debug("info","Creating final object with token, payload and pathname... (53)");var i={valid:o,tokens:e.tokens,payloads:e.payloads};Object.assign(i,r),e.Debug("info","Is valid? --\x3e "+e.validateURL()+"... (59)");var a=(e.validateURL()&&e.config.url.endpoints).access;e.Debug("info","Checking via HTTP to "+e.config.url.base+"/"+a+"... (67)"),e.validateURL()?e.checkHTTP({endpoint:a}).then(function(n){e.Debug("info","Finished initialization... (61)"),t(i),e.Debug("info","Returned an Object... (63)")}).catch(function(o){e.Debug("info","Access token expired... (66)"),e.Debug("info","Trying to get a new... (67)"),e.CheckStatus(o)&&"refresh"in e.tokens&&e.getNewToken().then(function(){return t()}).catch(function(e){return n(e)})}):n()}).catch(function(t){return e.Debug("error","Error trying to get the expiration of token... (76)")})}).catch(function(t){e.cleanTokens(),n(t)})}catch(e){n(e)}})}},{key:"setup",value:function(){var e=this;return new Promise(function(t,n){e.debug&&console.group("Setup");var o=e.remember?"localStorage":"sessionStorage";e.cleanTokens(),e.tokens.access?(e.Debug("info","Saving access token in "+o+"... (91)"),window[o].setItem(e.keys.access,e.tokens.access),e.tokens.refresh&&e.Debug("info","Saving refresh token in "+o+"... (94)"),e.tokens.refresh&&window[o].setItem(e.keys.refresh,e.tokens.refresh),e.setPayload("access"),e.tokens.access&&e.setPayload("refresh"),e.createChecker(),t()):n("Token is not defined"),e.debug&&console.groupEnd("Setup")})}},{key:"checkExpiration",value:function(e){var t=this;return new Promise(function(n,o){try{t.Debug("info","Checking token expiration... (125)");var r=1e3*t.payloads[e].exp>=(new Date).getTime();t.Debug("info","The token is "+r+"... (132)"),n(r)}catch(e){o(e)}})}},{key:"setPayload",value:function(e){var t=this;this.debug&&console.group("Setting Payload");this.Debug("info","Decoding payload of JWT... (148)");var n=(0,s.default)(this.tokens[e]);this.Debug("info","Return "+e+" JWT... (152)"),this.Debug("info",n),this.Debug("info","Setting "+e+" token... (155)"),this.payloads[e]="object"===(void 0===n?"undefined":r(n))?n:(t.Debug("error",{token:t.tokens[e],payload:t.payloads[e]}),t.Debug("error",new Error("[Auth Web] Payload isn't an object")),{}),this.debug&&console.groupEnd("Setting Payload")}},{key:"checkStorage",value:function(e){this.Debug("info","Checking storage... (161)");var t=window.localStorage.getItem(e)?"localStorage":"sessionStorage";return{storage:t,remember:"localStorage"===t}}},{key:"getFromStorage",value:function(e){return window[this.checkStorage(e).storage].getItem(e)}},{key:"cleanTokens",value:function(){this.Debug("info","Cleaning tokens... (172)"),window.localStorage.removeItem(this.keys.access),window.localStorage.removeItem(this.keys.refresh),window.sessionStorage.removeItem(this.keys.access),window.sessionStorage.removeItem(this.keys.refresh)}},{key:"getPathname",value:function(){return window.location.pathname}},{key:"nestedPathname",value:function(){this.debug&&console.group("Parsing nested path");var e=this.getPathname();(e=e.split("/")).shift();var t=[];return e.map(function(n,o){return t.push({path:e[o],level:o})}),this.debug&&console.groupEnd("Parsing nested path"),{plain:this.getPathname(),byLevels:t}}},{key:"getSearchOrHash",value:function(){var e=this;this.debug&&console.group("Getting search or hash in url");var t=function(t){e.Debug("info","Parsing URL for format... (206)");var n={},o=t.split("?");return e.Debug("info","Mapping and separating hash and search parameters... (221)"),o.map(function(t){t.includes("#")?n.hash=t.replace("#",""):t.includes("&")&&(n.search=function(t){e.Debug("info","Parsing search parameters in URL... (209)");var n={};return t.split("&").map(function(e){return n[e.split("=")[0]]=e.split("=")[1]}),n}(t))}),n},n=window.location.search,o=window.location.hash;return this.debug&&console.groupEnd("Getting search or hash in url"),t(n||o)}},{key:"checkHTTP",value:function(e){var t=this,n=e.endpoint,o=e.token,r=void 0===o?"access":o;return this.debug&&console.group("HTTP check"),new Promise(function(e,o){try{if(t.Debug("info","Checking "+r+" token by HTTP request... (243)"),t.validateURL()){var i=new Headers,a=t.config,s=a.headers,c=a.url,u=a.prefix,f=a.methods,h=a.bodies;s&&s[r]&&Object.keys(s).map(function(e){"authorization"!==e.toLowerCase()&&i.append(e,s[e])}),t.Debug("info","Adding access token to header... (260)"),i.append("Authorization",(u||"Bearer")+" "+t.tokens.access),t.Debug("info","Fetching to "+c.base+"/"+n+"... (258)"),fetch(c.base+"/"+n,{method:f?f[r]:"POST",headers:i,body:h?h[r]:{}}).then(function(n){t.Debug("info","Response with code "+n.status+"... (2)"),200===n.status||204===n.status?t.parse(n).then(function(t){return e(t)}):o(n)}).catch(function(e){t.Debug("info","Something is bad, please check request in Network DevTools tab."),t.parse(e).then(function(e,t){return o(t)})})}else t.Debug("info","Exiting HTTP validation... (272)"),void 0===t.config.url?e():o("[Auth Web] Config dont't have the correct format or url key not found.")}catch(e){o(console.log(e))}t.debug&&console.groupEnd("HTTP check")})}},{key:"getNewToken",value:function(){var e=this;return new Promise(function(t,n){if(e.Debug("info","Trying to get a new access token... (271)"),e.validateURL()&&"refresh"in e.tokens){var o=e.config.url,r=o.endpoints,i=o.keys;e.checkHTTP({endpoint:r.access,token:"refresh"}).then(function(o){e.tokens.access=o[i.access],e.setup().then(function(){return t()}).catch(function(){return n()})}).catch(function(e){return n(e)})}else n(e.Debug("error","[Auth Web] Trying to get a access token without mandatory keys."))})}},{key:"createChecker",value:function(){var e=this;this.Debug("info","Creating checker... (295)");this.interval.execute=window.setInterval(function(){!e.checkExpiration("access")&&e.interval.try<=5?(window.clearInterval(e.interval.execute),e.validateURL()&&"refresh"in e.tokens?e.getNewToken().catch(function(t){return e.CheckStatus(t)?e.expire():e.createChecker(e.interval.try++)}):e.expire()):e.interval.try>5&&setTimeout(function(){return e.createChecker(e.interval.try=0)},5e3)},1e3)}},{key:"validateURL",value:function(){return this.Debug("info","Validating URL... (318)"),"object"===r(this.config)&&"url"in this.config&&"object"===r(this.config.url)&&"endpoints"in this.config.url&&"object"===r(this.config.url.endpoints)&&"access"in this.config.url.endpoints}},{key:"parse",value:function(e){var t=this;return new Promise(function(n,o){t.Debug("info","Parsing fetch response... (353)"),e.json().then(function(t){return n(t,e.status)}).catch(function(e){return o(e)})})}},{key:"CheckStatus",value:function(e){return this.Debug("info","Checking status of fetch... (361)"),this.Debug("info","The status is "+e+"... (362)"),(this.validateURL()&&"status"in this.config.url&&this.config.url.status)===e}},{key:"expire",value:function(){this.Debug("info","Token has expired... (339)"),this.cleanTokens(),this.expired()}},{key:"Debug",value:function(e,t){var n="string"==typeof e?e:"info";this.config.debug&&console[n](t)}}]),e}()},function(e,t,n){"use strict";var o=n(2);function r(e){this.message=e}r.prototype=new Error,r.prototype.name="InvalidTokenError",e.exports=function(e,t){if("string"!=typeof e)throw new r("Invalid token specified");var n=!0===(t=t||{}).header?0:1;try{return JSON.parse(o(e.split(".")[n]))}catch(e){throw new r("Invalid token specified: "+e.message)}},e.exports.InvalidTokenError=r},function(e,t,n){"use strict";var o=n(3);e.exports=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(o(e).replace(/(.)/g,function(e,t){var n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}(t)}catch(e){return o(t)}}},function(e,t,n){"use strict";var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function r(e){this.message=e}r.prototype=new Error,r.prototype.name="InvalidCharacterError",e.exports="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new r("'atob' failed: The string to be decoded is not correctly encoded.");for(var n,i,a=0,s=0,c="";i=t.charAt(s++);~i&&(n=a%4?64*n+i:i,a++%4)?c+=String.fromCharCode(255&n>>(-2*a&6)):0)i=o.indexOf(i);return c}}])});
//# sourceMappingURL=web-auth.bundle.js.map